<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Passing Javascript Variables to Rails Controller</title>
  <meta name="description" content="“To the man who only has a hammer, everything he encounters begins to look like a nail.”">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/jekyll/update/2014/01/26/passing-javascript-variables-to-rails-controller.html">
  <link rel="alternate" type="application/rss+xml" title="Alex On Code" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Alex On Code</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Passing Javascript Variables to Rails Controller</h1>
    <p class="post-meta">
      <time datetime="2014-01-26T05:36:14-08:00" itemprop="datePublished">
        
        Jan 26, 2014
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>“To the man who only has a hammer, everything he encounters begins to look like a nail.”</p>

<ul>
  <li>Abraham Harold Maslow</li>
</ul>

<p>Ruby is an amazing programming language.  It ships with beautiful syntax, an extensive standard library, and more open source libraries  (via gems) than we could ever know what to do with.  However, every job requires different tools, and while there are almost always multiple ways to address a problem, I firmly believe you should make your life easier and pick the right tool for the job at hand. Ruby works great on the server side of most web applications, however when it comes to client-side programming there is no doubt that JavaScript reigns supreme.  Theres a reason it is often referred to as the language of the browser.  An understanding of JavaScript is a must for any modern day web developer and with the emergence of many awesome HTML5 APIs you would be missing out on a lot of fun if you didn’t have at least a basic understanding of it.</p>

<p>JavaScript runs on the client-side, while Ruby runs on the server-side of Rails projects.  Without going into too much detail, the internet is quite simple.  You type a URL into an address bar and see a website.  But what is actually happening? Well, a client, such as yourself, types in this URL and hits enter.  This sends an HTTP GET request to a server asking for the resource which is stored at that specific location.  Remember, URL simply stands for universal resource locator. In other words, a URL can be compared to the street address of some information that you want.  If your computer has provided the correct information about itself then the server answers with an HTTP response containing the stuff that you want, organizes the HTML files into a tree known as the DOM, at which point you are able to see the website how you’re used to seeing websites, and then runs the necessary JavaScript files.  This JavaScript then manipulates the content that has been delivered by the server - hence the name client side scripting.  Data getting sent to a server is quite similar.  To break it down very simply let’s just say that data is sent to a server via an HTTP POST request, The server receives the request and Ruby manipulates that data. If it receives a GET request for that data, the server proceeds to send it back to the browser (you) at which point JavaScript takes its turn again manipulating the returned content.</p>

<p>Most of the time you will be using JavaScript to manipulate content in the browser that has been returned from a server - and there will be times when you will want send some data back to the server for Ruby to work on.  How would you go about doing this?  JavaScript and Ruby are two different programming languages.  All of the code in between erb tags &lt;%= %&gt; is executed on the server, while any code between script tags <script></script> gets executed on the client. In other words these languages have no idea each other exists.  The easiest way to get JavaScript data back to the server is how most new data gets there - a form.</p>

<p>I came across this very problem recently in a project I’m working on. The premise of the app is that it gets a user’s current Latitude and Longitude via the HTML5 Geolocation API, makes a call to the Google Maps API, which returns a link to an image of that user’s Lat and Long marked on a map, followed by an API call to the Bit.ly API to retrieve a shortened URL of this link, all because finally I must POST this data to the Twilio API via a create action in one of my controllers to send a text containing this data to another user’s phone number.  The problem is that all of this happens on the client side via JavaScript and I must get it to my controller to POST to Twilio, save as a record in the DB and possibly call on some more external services in the feature (its always best to keep your software as flexible as possible for future iterations).</p>

<p>I knew that if I could somehow get the data into a form I could submit it to the controller.  Since JavaScript allows us to manipulate just about anything on a web page, then this problem should be no challenge for such a powerful programming language.  Don’t worry If you’re not even a little bit familiar with JavaScript/jQuery or the DOM, the following will only be a high level overview of my code.</p>

<p>The app is quite simple.  A user that wants to request a friend’s location visits a home page.  He or she fills in their phone number and a phone number for the friend who’s location they want.</p>

<p>image</p>

<p>A hyperlink is sent as a text message to the friend’s phone with a query string containing the original senders phone number set to the phonenumber parameter (my next post will cover how we solved data persistence in this app). When the friend clicks the link, a url of my app is opened, containing some JS code that executes upon page load. This JavaScript doesn’t only get the user’s lat/long, but also is the key to passing itself to my controller for further processing.  So, how does this work?</p>

<p>I have a form routed to the create action of my twilio_messages_controller:</p>

<p>twilio_messages/new_html_erb</p>

<div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@twilio_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span>   <span class="n">f</span><span class="p">.</span><span class="nf">hidden_field</span> <span class="ss">:to</span><span class="p">,</span> <span class="n">valu</span><span class="ss">:e</span> <span class="n">params</span><span class="p">[</span><span class="ss">:phonenumber</span><span class="p">]</span> <span class="cp">%&gt;</span><span class="nt">&lt;br&gt;</span>
<span class="cp">&lt;%=</span>   <span class="n">f</span><span class="p">.</span><span class="nf">hidden_field</span> <span class="ss">:from</span><span class="p">,</span> <span class="ss">value: </span><span class="s2">"+19498607430"</span> <span class="cp">%&gt;</span><span class="nt">&lt;br&gt;</span>
<span class="cp">&lt;%=</span>   <span class="n">f</span><span class="p">.</span><span class="nf">hidden_field</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">value: </span><span class="s2">""</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span>   <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Send ETA!"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"submit enabled"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
</div>
<p>twilio_messages_controller.rb</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">account_sid</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"TWILIO_ACCOUNT_SID"</span><span class="p">]</span>
  <span class="n">auth_token</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"TWILIO_AUTH_TOKEN"</span><span class="p">]</span>
  <span class="vi">@client</span> <span class="o">=</span> <span class="no">Twilio</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">account_sid</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">)</span>
  <span class="vi">@client</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">sms</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">twilio_message_params</span><span class="p">)</span>

  <span class="vi">@twilio_message</span> <span class="o">=</span> <span class="no">TwilioMessage</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">twilio_message_params</span><span class="p">)</span>

  <span class="k">if</span> <span class="vi">@twilio_message</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:phone</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:twilio_message</span><span class="p">][</span><span class="ss">:to</span><span class="p">]</span>
    <span class="n">redirect_to</span> <span class="n">twilio_message_success_path</span>
  <span class="k">else</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:phone</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:twilio_message</span><span class="p">][</span><span class="ss">:to</span><span class="p">]</span>
    <span class="n">redirect_to</span> <span class="n">twilio_message_failure_path</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="kp">private</span>

<span class="k">def</span> <span class="nf">twilio_message_params</span>
  <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:twilio_message</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:to</span><span class="p">,</span> <span class="ss">:from</span><span class="p">,</span> <span class="ss">:body</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p>It has two hidden fields, which aren’t visible to the user.  The form, seen below, actually just looks like a button, however it is indeed a form.</p>

<p><img src="/assets/geofun.png" alt="Geofun form" class="center-image" /></p>

<p>The To value is set by accessing the query string the original text message body appended on to the link that the friend opens.  The From value is always going to be my Twilio Number so this value is hardcoded (you don’t have the account_sid or auth_token so I’m not too worried).  They body is the text message body that will be sent.  In my case, I want it to be a map with the user’s location marked with a pin.  Remember how I stated how when the user opens the page it executes some JS code?  Well we’re now in a position to tie everything together and explain this in greater detail.  When the friend opens the text message link JavaScript code is executed that retrieves the device’s latitude and longitude via the HTML5 geolocation device API, sends the lat/long to Google Maps API, which returns a link to a google map with the user’s location marked on it. Then I take this url and make an AJAX request to the Bit.ly API to shorten the url since Twilio only allows text message bodies &lt; 160 characters and the url returned by Google Maps is very long.  Now I have the data stored in a JS variable and just need to get it in the form somehow - easy.</p>

<p>Browsers provide us with Javascript functions called event handlers, which allow a developer to trigger a certain function whenever an event occurs on a target element.  In other words you attach an event handler to a certian element and when a user does something to this element, something happens.   This could translate to a user clicking on a link and an alert box popping up, or a user scrolling over an element on a page and all of the images changing to different images.  You’ve probably had this happen to you countless number of times - and now you know you have JavaScript to thank for it.</p>

<p>One of these event handlers is onready (jQuery calls it ready( ) ), which fires a given function when all of the content on a page is done loading and it is ready to be manipulated by JavaScript.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">onready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">getMap</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>
</div>
<p>Put most basically, I wrapped all of my API calls in a ready( ) event handler so that when the friend loaded the page they all fired and the result was a Bit.ly shortened link containing my reference to the Google Maps API. I then took this variable and used some more of the power of Javascript to set that link as the value of the Body input. (note: the data.data.url parameter is just parsing the JSON response from Bit.ly)</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">shorturl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">"#twilio_message_body"</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The form is essentially completed by this JS and the friend only has to click the Send ETA button. This sends a POST request to the create action of my controller, with the request body being the form inputs, which are accessable like any other parameters in a controller:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">params</span><span class="p">[</span><span class="ss">:text_field_name</span><span class="p">]</span><span class="o">.</span>
</code></pre>
</div>

<p>i.e. params[:to], params[:from], params[:body].</p>

<p>If you’re using Rails4 don’t forget to whitelist these params in the corresponding controller.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">twilio_message_params</span>
  <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:twilio_message</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:to</span><span class="p">,</span> <span class="ss">:from</span><span class="p">,</span> <span class="ss">:body</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p>And thus the data I needed, which was stored in JavaScript variables has successfully been sent to my controller, saved to my database, and sent as an sms via Twilio:</p>

<p>twilio_messages_controller.rb#create</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="vi">@client</span> <span class="o">=</span> <span class="no">Twilio</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">account_sid</span><span class="p">,</span> <span class="n">auth_token</span><span class="p">)</span>
<span class="vi">@client</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">sms</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">twilio_message_params</span><span class="p">)</span>
</code></pre>
</div>

<p>Feel free to reach out if you have any questions or want to go more in depth about certain topics covered.</p>

<p>Check out the production app here: etaapp.herokuapp.com</p>

<p>@askwheeler</p>

<p>Find the GitHub repo here</p>

<p>Special thanks to great friends @NateChaseH and @netspencer​ for working on this app with me, making it beautiful, and continuously inspiring me.</p>

<p>Also check out my great friend John Capecelatro’s blog.  He is the one friend I know I can count on to be up on Saturday mornings ready to get together and hack - even after a long night out on the city.</p>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Alex On Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Alex On Code
            
            </li>
            
            <li><a href="mailto:afwheeler92@gmail.com">afwheeler92@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/alexwheeler"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">alexwheeler</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/askwheeler"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">askwheeler</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>write code
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
